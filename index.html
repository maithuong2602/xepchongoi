<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Sắp xếp Chỗ ngồi Thông minh</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas and jspdf for exporting to PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- SheetJS for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind gray-50 */
        }
        /* Custom styles for drag-and-drop */
        .dragging {
            opacity: 0.5;
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .seat.over {
            border: 2px dashed #3b82f6; /* Tailwind blue-500 */
        }
        .seat {
            transition: all 0.2s ease-in-out;
            cursor: default;
        }
        .seat-occupied {
            cursor: grab;
        }
        .seat-occupied:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Ứng dụng Sắp xếp Chỗ ngồi Thông minh</h1>
            <p class="text-gray-600 mt-2">Tải lên danh sách lớp, chọn tiêu chí và sắp xếp chỗ ngồi một cách hiệu quả.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content: Classroom Layout -->
            <main class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg" id="classroom-main">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Sơ đồ Lớp học</h2>
                <div id="teacher-desk" class="w-2/3 md:w-1/3 mx-auto mb-10 p-3 bg-indigo-200 text-indigo-800 font-semibold text-center rounded-lg shadow">Bàn Giáo viên</div>
                <div id="classroom" class="grid grid-cols-2 gap-x-4 md:gap-x-8">
                    <!-- Classroom layout will be generated here by JavaScript -->
                </div>
            </main>

            <!-- Sidebar: Controls -->
            <aside class="bg-white p-6 rounded-2xl shadow-lg h-fit">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6">Bảng điều khiển</h2>

                <!-- Step 1: Upload -->
                <div class="mb-6">
                    <label for="file-upload" class="block text-sm font-medium text-gray-700 mb-2">1. Tải lên Danh sách lớp (.xlsx)</label>
                    <input id="file-upload" type="file" accept=".xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-lg file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100 cursor-pointer"/>
                    <p class="text-xs text-gray-500 mt-1">Tệp phải có cột "Họ tên" và các môn điểm.</p>
                </div>

                <!-- Step 2: Criteria -->
                <div class="mb-6">
                    <label for="criteria" class="block text-sm font-medium text-gray-700 mb-2">2. Chọn Chức năng Sắp xếp</label>
                    <select id="criteria" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="smart">Sắp xếp thông minh</option>
                        <option value="random">Ngẫu nhiên</option>
                    </select>
                </div>
                <!-- Numbering Mode -->
                <div class="mb-6">
                    <label for="numbering-mode" class="block text-sm font-medium text-gray-700 mb-2">Chế độ hiển thị STT</label>
                    <select id="numbering-mode" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="absolute">Theo STT (1-40)</option>
                        <option value="group">Theo Nhóm (N1.1, N1.2...)</option>
                    </select>
                </div>
               
                <!-- Subject selection for smart arrangement -->
                <div id="subject-criteria-container" class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tiêu chí cho Sắp xếp thông minh</label>
                    <div id="subject-checkboxes" class="grid grid-cols-2 gap-2 p-3 border rounded-lg bg-gray-50">
                        <!-- Checkboxes will be dynamically inserted here -->
                        <p class="col-span-2 text-sm text-gray-500">Tải lên danh sách lớp để chọn môn.</p>
                    </div>
                </div>

                <!-- Step 3: Arrange -->
                <div class="mb-6">
                    <button id="arrange-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        3. Sắp xếp Tự động
                    </button>
                </div>
               
                <hr class="my-6">

                <!-- Other Actions -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Chức năng khác</h3>
                    <button id="export-pdf-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 mb-3 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Xuất ra PDF/Ảnh
                    </button>
                    <button id="clear-btn" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Xóa sơ đồ
                    </button>
                </div>

                <!-- Student List -->
                <div id="student-list-container" class="mt-8 hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Danh sách học sinh (<span id="student-count">0</span>)</h3>
                    <div id="student-list" class="max-h-96 overflow-y-auto bg-gray-50 p-3 rounded-lg border">
                        <!-- Student list items will be generated here -->
                    </div>
                </div>
            </aside>
        </div>
    </div>
    
    <!-- Custom Modal for Alerts/Messages -->
    <div id="modal-container" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Thông báo</h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button id="modal-ok-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal for adding a new student -->
    <div id="add-student-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Thêm học sinh mới</h3>
            <p class="text-sm text-gray-500 mb-4">Nhập tên học sinh để thêm vào chỗ trống.</p>
            <form id="add-student-form">
                <input type="text" id="new-student-name" placeholder="Tên học sinh..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mb-4" required>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-add-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Hủy</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Thêm</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileUpload = document.getElementById('file-upload');
            const criteriaSelect = document.getElementById('criteria');
            const numberingModeSelect = document.getElementById('numbering-mode');
            const subjectCriteriaContainer = document.getElementById('subject-criteria-container');
            const subjectCheckboxesDiv = document.getElementById('subject-checkboxes');
            const arrangeBtn = document.getElementById('arrange-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const clearBtn = document.getElementById('clear-btn');
            const classroomDiv = document.getElementById('classroom');
            const studentListDiv = document.getElementById('student-list');
            const studentListContainer = document.getElementById('student-list-container');
            const studentCountSpan = document.getElementById('student-count');
            const modalContainer = document.getElementById('modal-container');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalOkBtn = document.getElementById('modal-ok-btn');
            const addStudentModal = document.getElementById('add-student-modal');
            const addStudentForm = document.getElementById('add-student-form');
            const newStudentNameInput = document.getElementById('new-student-name');
            const cancelAddBtn = document.getElementById('cancel-add-btn');

            let students = [];
            let detectedSubjects = [];
            let draggedStudentData = null;
            let draggedElement = null;
            let seatToGroupMap = {};
            let groupToSeatsMap = {};
            let seatIdToAbsoluteNumber = {};
            let seatIdToGroupNumber = {};
            let currentArrangement = {}; // Store student objects by seatId
            let selectedEmptySeatId = null;

            // --- Custom Dialog Function ---
            function showDialog(message, title = 'Thông báo') {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalContainer.classList.remove('hidden');
            }

            modalOkBtn.addEventListener('click', () => {
                modalContainer.classList.add('hidden');
            });

            cancelAddBtn.addEventListener('click', () => {
                addStudentModal.classList.add('hidden');
            });

            // --- 1. INITIALIZE CLASSROOM LAYOUT ---
            function initializeClassroom() {
                classroomDiv.innerHTML = '';
                seatToGroupMap = {};
                groupToSeatsMap = {};
                seatIdToAbsoluteNumber = {};
                seatIdToGroupNumber = {};
                currentArrangement = {};
                
                // Define the physical layout of the classroom
                const columnGroups = [
                    [ // Groups for Column 0 (left)
                        { name: 'N4', rows: [0, 1, 2], color: 'border-indigo-400', textColor: 'text-indigo-500' },
                        { name: 'N5', rows: [3, 4, 5], color: 'border-purple-400', textColor: 'text-purple-500' },
                        { name: 'N6', rows: [6, 7, 8, 9], color: 'border-pink-400', textColor: 'text-pink-500' }
                    ],
                    [ // Groups for Column 1 (right)
                        { name: 'N1', rows: [0, 1, 2], color: 'border-rose-400', textColor: 'text-rose-500' },
                        { name: 'N2', rows: [3, 4, 5], color: 'border-sky-400', textColor: 'text-sky-500' },
                        { name: 'N3', rows: [6, 7, 8, 9], color: 'border-teal-400', textColor: 'text-teal-500' }
                    ]
                ];

                const numCols = 2;
                let absoluteSeatCounter = 1;

                // Create the layout and map seats to groups and numbers
                for (let i = 0; i < numCols; i++) {
                    const columnEl = document.createElement('div');
                    columnEl.className = 'flex flex-col gap-4';

                    const groupsForThisCol = columnGroups[i];
                    groupsForThisCol.forEach(group => {
                        const groupWrapper = document.createElement('div');
                        groupWrapper.className = `relative p-2 rounded-xl border-2 ${group.color}`;
                        groupWrapper.innerHTML = `<span class="absolute -top-2.5 left-4 bg-white px-2 font-semibold text-sm ${group.textColor}">${group.name}</span>`;
                        
                        const desksInGroupWrapper = document.createElement('div');
                        desksInGroupWrapper.className = 'flex flex-col gap-2';

                        group.rows.forEach(j => {
                            const deskContainer = document.createElement('div');
                            const leftSeatId = `seat-${absoluteSeatCounter}`;
                            const rightSeatId = `seat-${absoluteSeatCounter + 1}`;
                            const leftAbsoluteNumber = absoluteSeatCounter;
                            const rightAbsoluteNumber = absoluteSeatCounter + 1;
                            
                            seatToGroupMap[leftSeatId] = group.name;
                            seatToGroupMap[rightSeatId] = group.name;
                            if (!groupToSeatsMap[group.name]) groupToSeatsMap[group.name] = [];
                            groupToSeatsMap[group.name].push(leftSeatId, rightSeatId);
                            seatIdToAbsoluteNumber[leftSeatId] = leftAbsoluteNumber;
                            seatIdToAbsoluteNumber[rightSeatId] = rightAbsoluteNumber;

                            // Dynamic group numbering
                            const groupNumber = parseInt(group.name.replace('N', ''));
                            seatIdToGroupNumber[leftSeatId] = `${groupNumber}.${j * 2 + 1}`;
                            seatIdToGroupNumber[rightSeatId] = `${groupNumber}.${j * 2 + 2}`;

                            deskContainer.innerHTML = `
                                <div class="desk bg-gray-50 rounded-lg p-1.5 flex gap-1 justify-center border-2 border-gray-200">
                                    <div class="seat w-1/2 h-14 bg-white rounded-md flex items-center justify-center text-center text-gray-500 p-1 border relative seat-empty" data-seat-id="${leftSeatId}">
                                        <span class="seat-number absolute top-0.5 left-1 text-slate-400 text-[10px] font-semibold">${leftAbsoluteNumber}</span>
                                        <span class="student-name text-xs leading-tight font-medium">[Trống]</span>
                                    </div>
                                    <div class="seat w-1/2 h-14 bg-white rounded-md flex items-center justify-center text-center text-gray-500 p-1 border relative seat-empty" data-seat-id="${rightSeatId}">
                                        <span class="seat-number absolute top-0.5 left-1 text-slate-400 text-[10px] font-semibold">${rightAbsoluteNumber}</span>
                                        <span class="student-name text-xs leading-tight font-medium">[Trống]</span>
                                    </div>
                                </div>`;
                            desksInGroupWrapper.appendChild(deskContainer);
                            absoluteSeatCounter += 2;
                        });
                        groupWrapper.appendChild(desksInGroupWrapper);
                        columnEl.appendChild(groupWrapper);
                    });
                    classroomDiv.appendChild(columnEl);
                }
                
                // Add drag-and-drop and click listeners to all seats
                addDropListenersToSeats();
                addClickListenersToEmptySeats();
                updateSeatNumberDisplay();
                updateButtonStates(false);
            }

            // Update button disabled state
            function updateButtonStates(hasData) {
                arrangeBtn.disabled = !hasData;
                exportPdfBtn.disabled = !hasData;
                clearBtn.disabled = !hasData;
            }

            function updateSeatNumberDisplay() {
                const mode = numberingModeSelect.value;
                document.querySelectorAll('.seat').forEach(seat => {
                    const seatId = seat.dataset.seatId;
                    const numberSpan = seat.querySelector('.seat-number');
                    if (numberSpan) {
                        numberSpan.textContent = mode === 'absolute' ? seatIdToAbsoluteNumber[seatId] : seatIdToGroupNumber[seatId];
                    }
                });
            }

            function getShortName(fullName) {
                const nameParts = fullName.trim().split(' ');
                // Lấy 2 từ cuối cùng để làm tên hiển thị
                if (nameParts.length < 2) {
                    return fullName;
                }
                return nameParts.slice(-2).join(' ');
            }

            function getGivenName(fullName) {
                const nameParts = fullName.trim().split(' ');
                return nameParts[nameParts.length - 1];
            }
            
            // --- 2. FILE UPLOAD & DATA PROCESSING ---
            fileUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                        processStudentData(jsonData);
                    } catch (error) {
                        showDialog('Đã xảy ra lỗi khi đọc tệp. Vui lòng kiểm tra lại định dạng.', 'Lỗi');
                    }
                };
                reader.readAsArrayBuffer(file);
            });
            
            function processStudentData(data) {
                if (!data || data.length < 8) {
                    showDialog('Không tìm thấy dữ liệu học sinh hợp lệ. Vui lòng đảm bảo tệp có ít nhất 8 hàng.', 'Lỗi Dữ liệu');
                    return;
                }

                const headerRow = data[6];
                const firstStudentRow = data[7];
                detectedSubjects = [];
                let genderIndex = -1;

                headerRow.forEach((header, index) => {
                    const headerText = String(header).trim().toLowerCase();
                    if (headerText.includes('giới')) {
                        genderIndex = index;
                    }
                    if (index >= 5 && header && !headerText.includes('trạng thái') && !headerText.includes('rèn luyện') && !headerText.includes('danh hiệu')) {
                        const cellValue = firstStudentRow[index] ? String(firstStudentRow[index]).trim().toLowerCase() : '';
                        const numericScore = parseFloat(cellValue.replace(',', '.'));
                        if (!isNaN(numericScore) || cellValue === 'đ') {
                            detectedSubjects.push({ name: String(header), index: index });
                        }
                    }
                });

                if (detectedSubjects.length === 0) {
                    showDialog('Không thể nhận diện các môn học. Vui lòng kiểm tra lại định dạng tệp.', 'Lỗi Dữ liệu');
                    return;
                }
                createSubjectCheckboxes();

                students = data.slice(7).map(row => {
                    if (!row || !row[1] || isNaN(parseFloat(row[0]))) return null;
                    const fullName = String(row[1]).trim();
                    if (!fullName) return null;
                    const studentData = {
                        name: getShortName(fullName),
                        givenName: getGivenName(fullName),
                        fullName: fullName,
                        gender: genderIndex !== -1 ? String(row[genderIndex]).trim().toLowerCase() : 'n/a',
                        scores: {}
                    };
                    let hasData = false;
                    detectedSubjects.forEach(subject => {
                        const scoreStr = row[subject.index] ? String(row[subject.index]).trim().toLowerCase() : '';
                        const numericScore = parseFloat(scoreStr.replace(',', '.'));
                        if (!isNaN(numericScore)) {
                            studentData.scores[subject.name] = numericScore;
                            hasData = true;
                        } else if (scoreStr === 'đ') {
                            studentData.scores[subject.name] = 1;
                            hasData = true;
                        } else {
                            studentData.scores[subject.name] = 0;
                        }
                    });
                    return hasData ? studentData : null;
                }).filter(student => student !== null);

                if (students.length === 0) {
                    showDialog('Không tìm thấy dữ liệu học sinh hợp lệ trong tệp.', 'Lỗi Dữ liệu');
                    return;
                }
                updateStudentList(students);
                updateButtonStates(true);
            }

            function createSubjectCheckboxes() {
                subjectCheckboxesDiv.innerHTML = '';
                detectedSubjects.forEach(subject => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    const id = `cb-${subject.name.replace(/\s/g, '')}`;
                    const isChecked = ['Toán', 'Tin học'].includes(subject.name);
                    div.innerHTML = `
                        <input id="${id}" name="subject" value="${subject.name}" type="checkbox" ${isChecked ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="${id}" class="ml-2 block text-sm text-gray-900">${subject.name}</label>
                    `;
                    subjectCheckboxesDiv.appendChild(div);
                });
            }

            function updateStudentList(studentArray) {
                studentListDiv.innerHTML = '';
                studentArray.forEach(student => {
                    const studentItem = document.createElement('div');
                    studentItem.className = 'text-sm p-1.5 bg-white rounded-md mb-1.5 shadow-sm';
                    let scoresHtml = Object.entries(student.scores)
                        .map(([name, score]) => `<span class="font-mono text-xs text-gray-600">${name.substring(0,3)}: ${score ?? 'N/A'}</span>`)
                        .join(' | ');
                    studentItem.innerHTML = `
                        <div class="flex justify-between items-center font-medium">${student.fullName}</div>
                        <div class="mt-1">${scoresHtml}</div>
                    `;
                    studentListDiv.appendChild(studentItem);
                });
                studentCountSpan.textContent = studentArray.length;
                studentListContainer.classList.remove('hidden');
            }

            // --- 3. ARRANGEMENT LOGIC ---
            criteriaSelect.addEventListener('change', () => {
                subjectCriteriaContainer.style.display = criteriaSelect.value === 'smart' ? 'block' : 'none';
            });

            numberingModeSelect.addEventListener('change', updateSeatNumberDisplay);
            
            arrangeBtn.addEventListener('click', () => {
                if (students.length === 0) {
                    showDialog('Vui lòng tải lên danh sách lớp trước.', 'Thông báo');
                    return;
                }
                
                const criteria = criteriaSelect.value;
                let arrangedStudents = [...students];
                let seatOrder = [];

                if (criteria === 'random') {
                    // Xáo trộn danh sách học sinh
                    for (let i = arrangedStudents.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [arrangedStudents[i], arrangedStudents[j]] = [arrangedStudents[j], arrangedStudents[i]];
                    }
                    // Sắp xếp theo thứ tự mặc định của sơ đồ
                    seatOrder = Array.from(document.querySelectorAll('.seat')).map(s => s.dataset.seatId);
                } else { // Sắp xếp thông minh
                    const selectedSubjects = Array.from(subjectCheckboxesDiv.querySelectorAll('input:checked')).map(cb => cb.value);
                    if (selectedSubjects.length === 0) {
                        showDialog('Vui lòng chọn ít nhất một môn học để sắp xếp thông minh.', 'Thông báo');
                        return;
                    }

                    // Tính điểm trung bình cho mỗi học sinh
                    arrangedStudents.forEach(student => {
                        let sum = 0;
                        let count = 0;
                        selectedSubjects.forEach(subjectName => {
                            if (student.scores[subjectName] !== null) {
                                sum += student.scores[subjectName];
                                count++;
                            }
                        });
                        student.keyScore = count > 0 ? sum / count : 0;
                    });
                    
                    // Sắp xếp học sinh theo điểm trung bình giảm dần
                    arrangedStudents.sort((a, b) => b.keyScore - a.keyScore);
                    
                    // Lấy thứ tự chỗ ngồi tùy chỉnh của bạn
                    seatOrder = getCustomOrderedSeatIds();
                }
                
                populateClassroom(arrangedStudents, seatOrder);
                exportPdfBtn.disabled = false;
            });
            
            // Hàm tạo thứ tự chỗ ngồi tùy chỉnh dựa trên yêu cầu của bạn
            function getCustomOrderedSeatIds() {
                // Thứ tự chỗ ngồi ưu tiên theo số tuyệt đối
                const customAbsoluteSeatOrder = [
                    1, 21, 7, 27, 13, 33, 34, 14, 28, 8, 22, 2, 3, 23, 9, 29, 15, 35, 36, 16, 10, 30, 24, 4, 5, 25, 11, 31, 17, 37
                ];
                
                // Chuyển đổi các số tuyệt đối thành seatId
                const prioritySeatIds = customAbsoluteSeatOrder.map(num => `seat-${num}`);
                
                // Lấy tất cả các seatId hiện có trên sơ đồ
                const allSeats = Array.from(document.querySelectorAll('.seat')).map(s => s.dataset.seatId);
                
                // Lọc ra các ghế còn lại chưa được liệt kê
                const remainingSeats = allSeats.filter(seatId => !prioritySeatIds.includes(seatId)).sort((a, b) => seatIdToAbsoluteNumber[a] - seatIdToAbsoluteNumber[b]);
                
                return [...prioritySeatIds, ...remainingSeats];
            }

            function populateClassroom(arrangedList, seatOrder) {
                // Clear existing students
                document.querySelectorAll('.seat').forEach(seat => {
                    const studentNameSpan = seat.querySelector('.student-name');
                    studentNameSpan.textContent = '[Trống]';
                    seat.title = '';
                    seat.classList.remove('text-black', 'cursor-grab', 'seat-occupied');
                    seat.classList.add('text-gray-500', 'seat-empty');
                    seat.draggable = false;
                    const deleteBtn = seat.querySelector('.delete-btn');
                    if (deleteBtn) deleteBtn.remove();
                });
                currentArrangement = {}; // Reset arrangement map

                // Populate seats with students
                for (let i = 0; i < arrangedList.length && i < seatOrder.length; i++) {
                    const student = arrangedList[i];
                    const seatId = seatOrder[i];
                    const seat = document.querySelector(`.seat[data-seat-id='${seatId}']`);
                    if (seat) {
                        const studentNameSpan = seat.querySelector('.student-name');
                        studentNameSpan.textContent = student.name;
                        seat.title = `${student.fullName}${student.keyScore !== undefined ? '\nĐiểm TB: ' + student.keyScore.toFixed(2) : ''}`;
                        seat.classList.remove('text-gray-500', 'seat-empty');
                        seat.classList.add('text-black', 'seat-occupied');
                        seat.draggable = true;
                        currentArrangement[seat.dataset.seatId] = student;
                        addDragListenersToStudent(seat);
                        addDeleteButton(seat);
                    }
                }
                updateStudentListByGroup();
            }
            
            function updateStudentListByGroup() {
                const studentsByGroup = {};
                for (const groupName in groupToSeatsMap) {
                    studentsByGroup[groupName] = [];
                }
                
                for (const seatId in currentArrangement) {
                    const student = currentArrangement[seatId];
                    if (student) { // <-- Thêm kiểm tra này để xử lý chỗ trống
                        const groupName = seatToGroupMap[seatId];
                        if (groupName && studentsByGroup[groupName]) {
                            studentsByGroup[groupName].push({student, seatId});
                        }
                    }
                }
                
                studentListDiv.innerHTML = '';
                let totalStudents = 0;
                
                // Define a custom display order for groups
                const groupOrder = ['N1', 'N2', 'N3', 'N4', 'N5', 'N6'];
                
                groupOrder.forEach(groupName => {
                    const groupStudents = studentsByGroup[groupName];
                    if (groupStudents && groupStudents.length > 0) {
                        groupStudents.sort((a, b) => seatIdToAbsoluteNumber[a.seatId] - seatIdToAbsoluteNumber[b.seatId]);
                        
                        const groupTitle = document.createElement('h4');
                        groupTitle.className = 'text-md font-semibold mt-3 mb-1 text-gray-800';
                        groupTitle.textContent = `Nhóm ${groupName}`;
                        studentListDiv.appendChild(groupTitle);

                        groupStudents.forEach(({ student }) => {
                            totalStudents++;
                            const studentItem = document.createElement('div');
                            studentItem.className = 'text-sm p-1.5 bg-white rounded-md mb-1.5 shadow-sm flex justify-between items-center';
                            const keyScoreText = student.keyScore !== undefined ? student.keyScore.toFixed(2) : 'N/A';
                            studentItem.innerHTML = `
                                <span>${student.fullName}</span>
                                <span class="font-mono text-xs text-gray-600">ĐTB: ${keyScoreText}</span>
                            `;
                            studentListDiv.appendChild(studentItem);
                        });
                    }
                });
                studentCountSpan.textContent = totalStudents;
                studentListContainer.classList.remove('hidden');
            }
            
            // --- 4. DRAG-AND-DROP LOGIC ---
            function addDragListenersToStudent(element) {
                element.addEventListener('dragstart', (e) => {
                    draggedElement = e.target;
                    draggedStudentData = currentArrangement[draggedElement.dataset.seatId];
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                });
                element.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                    draggedElement = null;
                    draggedStudentData = null;
                });
            }

            function addDropListenersToSeats() {
                document.querySelectorAll('.seat').forEach(seat => {
                    seat.addEventListener('dragover', (e) => e.preventDefault());
                    seat.addEventListener('dragleave', (e) => seat.classList.remove('over'));
                    seat.addEventListener('dragenter', (e) => {
                        e.preventDefault();
                        seat.classList.add('over');
                    });
                    seat.addEventListener('drop', (e) => {
                        e.preventDefault();
                        seat.classList.remove('over');
                        if (draggedElement && draggedElement !== seat) {
                            const targetSeatId = seat.dataset.seatId;
                            const sourceSeatId = draggedElement.dataset.seatId;
                            
                            const targetStudentData = currentArrangement[targetSeatId];
                            
                            // Swap students in the internal state
                            currentArrangement[sourceSeatId] = targetStudentData || null;
                            currentArrangement[targetSeatId] = draggedStudentData;

                            // Update UI for source seat
                            const sourceNameSpan = draggedElement.querySelector('.student-name');
                            const targetNameSpan = seat.querySelector('.student-name');
                            
                            sourceNameSpan.textContent = targetStudentData ? targetStudentData.name : '[Trống]';
                            draggedElement.title = targetStudentData ? `${targetStudentData.fullName}${targetStudentData.keyScore !== undefined ? '\nĐiểm TB: ' + targetStudentData.keyScore.toFixed(2) : ''}` : '';
                            draggedElement.draggable = !!targetStudentData;
                            draggedElement.classList.toggle('seat-occupied', !!targetStudentData);
                            draggedElement.classList.toggle('text-gray-500', !targetStudentData);
                            draggedElement.classList.toggle('text-black', !!targetStudentData);
                            draggedElement.classList.toggle('seat-empty', !targetStudentData);
                            if(targetStudentData) {
                                addDeleteButton(draggedElement);
                            } else {
                                const deleteBtn = draggedElement.querySelector('.delete-btn');
                                if (deleteBtn) deleteBtn.remove();
                            }

                            // Update UI for target seat
                            targetNameSpan.textContent = draggedStudentData.name;
                            seat.title = `${draggedStudentData.fullName}${draggedStudentData.keyScore !== undefined ? '\nĐiểm TB: ' + draggedStudentData.keyScore.toFixed(2) : ''}`;
                            seat.draggable = true;
                            seat.classList.add('seat-occupied', 'text-black');
                            seat.classList.remove('text-gray-500', 'seat-empty');
                            addDeleteButton(seat);

                            // Re-apply drag listeners to ensure both seats are correctly set up for future drags
                            addDragListenersToStudent(draggedElement);
                            addDragListenersToStudent(seat);

                            // Update the student list on the sidebar
                            updateStudentListByGroup();
                        }
                    });
                });
            }
            
            // --- 5. ADD/DELETE STUDENT LOGIC ---
            function addClickListenersToEmptySeats() {
                document.querySelectorAll('.seat-empty').forEach(seat => {
                    seat.addEventListener('click', () => {
                        selectedEmptySeatId = seat.dataset.seatId;
                        newStudentNameInput.value = '';
                        addStudentModal.classList.remove('hidden');
                        newStudentNameInput.focus();
                    });
                });
            }

            addStudentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const studentName = newStudentNameInput.value.trim();
                if (!studentName) {
                    showDialog('Vui lòng nhập tên học sinh.', 'Lỗi');
                    return;
                }
                
                const newStudent = {
                    fullName: studentName,
                    name: getShortName(studentName),
                    givenName: getGivenName(studentName),
                    gender: 'n/a',
                    scores: {},
                    isCustom: true // Dấu hiệu nhận biết học sinh được thêm thủ công
                };

                const seat = document.querySelector(`.seat[data-seat-id='${selectedEmptySeatId}']`);
                if (seat) {
                    currentArrangement[selectedEmptySeatId] = newStudent;
                    const studentNameSpan = seat.querySelector('.student-name');
                    studentNameSpan.textContent = newStudent.name;
                    seat.title = newStudent.fullName;
                    seat.classList.remove('text-gray-500', 'seat-empty');
                    seat.classList.add('text-black', 'seat-occupied');
                    seat.draggable = true;
                    addDragListenersToStudent(seat);
                    addDeleteButton(seat);
                    updateStudentListByGroup();
                    
                    // Add the new student to the global students array for consistency
                    students.push(newStudent);
                }

                addStudentModal.classList.add('hidden');
                selectedEmptySeatId = null;
                // Re-attach listeners to ensure new empty seats are clickable
                addClickListenersToEmptySeats();
            });

            function addDeleteButton(seatElement) {
                if (seatElement.querySelector('.delete-btn')) return;

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn absolute top-0 right-0 w-4 h-4 text-xs font-bold text-red-500 bg-white rounded-full border border-red-500 leading-none flex items-center justify-center -mt-2 -mr-2 hover:bg-red-500 hover:text-white transition duration-200';
                deleteBtn.innerHTML = 'x';
                deleteBtn.title = 'Xóa học sinh';
                
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent seat click event from firing
                    const seatId = seatElement.dataset.seatId;
                    const studentData = currentArrangement[seatId];
                    if (studentData) {
                        delete currentArrangement[seatId];
                        
                        const studentNameSpan = seatElement.querySelector('.student-name');
                        studentNameSpan.textContent = '[Trống]';
                        seatElement.title = '';
                        seatElement.classList.remove('seat-occupied', 'text-black');
                        seatElement.classList.add('seat-empty', 'text-gray-500');
                        seatElement.draggable = false;
                        
                        deleteBtn.remove();
                        updateStudentListByGroup();

                        // Remove from the global student list if it was manually added
                        if (studentData.isCustom) {
                            const studentIndex = students.findIndex(s => s.fullName === studentData.fullName);
                            if (studentIndex > -1) {
                                students.splice(studentIndex, 1);
                            }
                        }
                    }
                    // Re-attach listeners to ensure empty seats are clickable again
                    addClickListenersToEmptySeats();
                });

                seatElement.appendChild(deleteBtn);
            }

            // --- 6. OTHER ACTIONS ---
            clearBtn.addEventListener('click', () => {
                initializeClassroom();
                students = [];
                updateButtonStates(false);
                studentListDiv.innerHTML = '';
                studentListContainer.classList.add('hidden');
                studentCountSpan.textContent = '0';
                fileUpload.value = '';
                subjectCheckboxesDiv.innerHTML = '<p class="col-span-2 text-sm text-gray-500">Tải lên danh sách lớp để chọn môn.</p>';
            });
            
            exportPdfBtn.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const classroomElement = document.getElementById('classroom-main');
                
                html2canvas(classroomElement, {
                    scale: 2,
                    windowWidth: classroomElement.scrollWidth,
                    windowHeight: classroomElement.scrollHeight
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({
                        orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                        unit: 'px',
                        format: [canvas.width, canvas.height]
                    });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`so-do-lop-hoc-${new Date().toISOString().slice(0,10)}.pdf`);
                });
            });

            // Initial setup
            initializeClassroom();
        });
    </script>
</body>
</html>
