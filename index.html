<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Sắp xếp Chỗ ngồi Thông minh</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse for reading CSV files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
    <!-- html2canvas and jspdf for exporting to PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- SheetJS for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind gray-50 */
        }
        /* Custom styles for drag-and-drop */
        .dragging {
            opacity: 0.5;
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
        }
        .seat.over {
            border: 2px dashed #3b82f6; /* Tailwind blue-500 */
        }
        .seat {
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Ứng dụng Sắp xếp Chỗ ngồi Thông minh</h1>
            <p class="text-gray-600 mt-2">Tải lên danh sách lớp, chọn tiêu chí và sắp xếp chỗ ngồi một cách hiệu quả.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content: Classroom Layout -->
            <main class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Sơ đồ Lớp học</h2>
                <div id="teacher-desk" class="w-2/3 md:w-1/3 mx-auto mb-10 p-3 bg-indigo-200 text-indigo-800 font-semibold text-center rounded-lg shadow">Bàn Giáo viên</div>
                <div id="classroom" class="grid grid-cols-2 gap-x-4 md:gap-x-8">
                    <!-- Classroom layout will be generated here by JavaScript -->
                </div>
            </main>

            <!-- Sidebar: Controls -->
            <aside class="bg-white p-6 rounded-2xl shadow-lg h-fit">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6">Bảng điều khiển</h2>

                <!-- Step 1: Upload -->
                <div class="mb-6">
                    <label for="file-upload" class="block text-sm font-medium text-gray-700 mb-2">1. Tải lên Danh sách lớp (.xlsx)</label>
                    <input id="file-upload" type="file" accept=".xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-lg file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100 cursor-pointer"/>
                    <p class="text-xs text-gray-500 mt-1">Tệp phải có cột "Họ tên" và các môn điểm.</p>
                </div>

                <!-- Step 2: Criteria -->
                <div class="mb-6">
                    <label for="criteria" class="block text-sm font-medium text-gray-700 mb-2">2. Chọn Chức năng Sắp xếp</label>
                    <select id="criteria" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="smart">Sắp xếp thông minh</option>
                        <option value="random">Ngẫu nhiên</option>
                    </select>
                </div>
                 <!-- Numbering Mode -->
                <div class="mb-6">
                    <label for="numbering-mode" class="block text-sm font-medium text-gray-700 mb-2">Chế độ hiển thị STT</label>
                    <select id="numbering-mode" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="absolute">Theo STT (1-40)</option>
                        <option value="group">Theo Nhóm (N1.1, N1.2...)</option>
                    </select>
                </div>
                
                <!-- Subject selection for smart arrangement -->
                <div id="subject-criteria-container" class="mb-6">
                     <label class="block text-sm font-medium text-gray-700 mb-2">Tiêu chí cho Sắp xếp thông minh</label>
                     <div id="subject-checkboxes" class="grid grid-cols-2 gap-2 p-3 border rounded-lg bg-gray-50">
                         <!-- Checkboxes will be dynamically inserted here -->
                         <p class="col-span-2 text-sm text-gray-500">Tải lên danh sách lớp để chọn môn.</p>
                     </div>
                </div>

                <!-- Step 3: Arrange -->
                <div class="mb-6">
                    <button id="arrange-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        3. Sắp xếp Tự động
                    </button>
                </div>
                
                <hr class="my-6">

                <!-- Other Actions -->
                <div>
                     <h3 class="text-lg font-semibold text-gray-700 mb-4">Chức năng khác</h3>
                    <button id="export-pdf-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 mb-3 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Xuất ra PDF/Ảnh
                    </button>
                    <button id="clear-btn" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Xóa sơ đồ
                    </button>
                </div>

                <!-- Student List -->
                <div id="student-list-container" class="mt-8 hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Danh sách học sinh (<span id="student-count">0</span>)</h3>
                    <div id="student-list" class="max-h-96 overflow-y-auto bg-gray-50 p-3 rounded-lg border">
                        <!-- Student list items will be generated here -->
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileUpload = document.getElementById('file-upload');
            const criteriaSelect = document.getElementById('criteria');
            const numberingModeSelect = document.getElementById('numbering-mode');
            const subjectCriteriaContainer = document.getElementById('subject-criteria-container');
            const subjectCheckboxesDiv = document.getElementById('subject-checkboxes');
            const arrangeBtn = document.getElementById('arrange-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const clearBtn = document.getElementById('clear-btn');
            const classroomDiv = document.getElementById('classroom');
            const studentListDiv = document.getElementById('student-list');
            const studentListContainer = document.getElementById('student-list-container');
            const studentCountSpan = document.getElementById('student-count');

            let students = [];
            let detectedSubjects = [];
            let draggedElement = null;
            let seatToGroupMap = {};
            let groupToSeatsMap = {};
            let seatIdToAbsoluteNumber = {};
            let seatIdToGroupNumber = {};

            // Khởi tạo trạng thái ban đầu cho các nút
            arrangeBtn.disabled = true;
            exportPdfBtn.disabled = true;
            clearBtn.disabled = true;

            // --- 1. KHỞI TẠO SƠ ĐỒ LỚP HỌC ---
            function initializeClassroom() {
                classroomDiv.innerHTML = '';
                seatToGroupMap = {};
                groupToSeatsMap = {};
                seatIdToAbsoluteNumber = {};
                seatIdToGroupNumber = {};
                classroomDiv.className = 'grid grid-cols-2 gap-x-4 md:gap-x-8';
                const numCols = 2;

                const columnGroups = [
                    [ // Groups for Column 0 (left)
                        { name: 'N4', rows: [0, 1, 2], color: 'border-indigo-400', textColor: 'text-indigo-500' },
                        { name: 'N5', rows: [3, 4, 5], color: 'border-purple-400', textColor: 'text-purple-500' },
                        { name: 'N6', rows: [6, 7, 8, 9], color: 'border-pink-400', textColor: 'text-pink-500' }
                    ],
                    [ // Groups for Column 1 (right)
                        { name: 'N1', rows: [0, 1, 2], color: 'border-rose-400', textColor: 'text-rose-500' },
                        { name: 'N2', rows: [3, 4, 5], color: 'border-sky-400', textColor: 'text-sky-500' },
                        { name: 'N3', rows: [6, 7, 8, 9], color: 'border-teal-400', textColor: 'text-teal-500' }
                    ]
                ];

                const tempGroupSeats = {};
                columnGroups.forEach((col, i) => {
                    col.forEach(group => {
                        if (!tempGroupSeats[group.name]) tempGroupSeats[group.name] = [];
                        group.rows.forEach(j => {
                            const leftSeatId = i * 20 + j * 2;
                            const rightSeatId = i * 20 + j * 2 + 1;
                            tempGroupSeats[group.name].push({ row: j, leftId: leftSeatId, rightId: rightSeatId });
                        });
                    });
                });

                for (const groupName in tempGroupSeats) {
                    const seatsInGroup = tempGroupSeats[groupName];
                    seatsInGroup.sort((a, b) => a.row - b.row);
                    const groupNum = groupName.replace('N', '');
                    const numRowsInGroup = seatsInGroup.length;

                    for (let i = 0; i < numRowsInGroup; i++) {
                        const seatId = seatsInGroup[i].rightId;
                        seatIdToGroupNumber[seatId] = `${groupNum}.${i + 1}`;
                    }
                    for (let i = 0; i < numRowsInGroup; i++) {
                        const seatId = seatsInGroup[numRowsInGroup - 1 - i].leftId;
                        seatIdToGroupNumber[seatId] = `${groupNum}.${numRowsInGroup + i + 1}`;
                    }
                }

                for (let i = 0; i < numCols; i++) {
                    const columnEl = document.createElement('div');
                    columnEl.className = 'flex flex-col gap-4'; 

                    const groupsForThisCol = columnGroups[i];

                    groupsForThisCol.forEach(group => {
                        if (!groupToSeatsMap[group.name]) groupToSeatsMap[group.name] = [];
                        const groupWrapper = document.createElement('div');
                        groupWrapper.className = `relative p-2 rounded-xl border-2 ${group.color}`;
                        groupWrapper.innerHTML = `<span class="absolute -top-2.5 left-4 bg-white px-2 font-semibold text-sm ${group.textColor}">${group.name}</span>`;
                        
                        const desksInGroupWrapper = document.createElement('div');
                        desksInGroupWrapper.className = 'flex flex-col gap-2';

                        group.rows.forEach(j => {
                            const deskContainer = document.createElement('div');
                            const leftSeatId = i * 20 + j * 2;
                            const rightSeatId = i * 20 + j * 2 + 1;
                            const leftSeatNumber = j * numCols * 2 + i * 2 + 1;
                            const rightSeatNumber = j * numCols * 2 + i * 2 + 2;
                            
                            seatToGroupMap[leftSeatId] = group.name;
                            seatToGroupMap[rightSeatId] = group.name;
                            groupToSeatsMap[group.name].push(leftSeatId, rightSeatId);
                            seatIdToAbsoluteNumber[leftSeatId] = leftSeatNumber;
                            seatIdToAbsoluteNumber[rightSeatId] = rightSeatNumber;

                            deskContainer.innerHTML = `
                                <div class="desk bg-gray-50 rounded-lg p-1.5 flex gap-1 justify-center border-2 border-gray-200">
                                    <div class="seat w-1/2 h-14 bg-white rounded-md flex items-center justify-center text-center text-gray-500 p-1 border relative" data-seat-id="${leftSeatId}">
                                        <span class="seat-number absolute top-0.5 left-1 text-slate-400 text-[10px] font-semibold">${leftSeatNumber}</span>
                                        <span class="student-name text-xs leading-tight font-medium">[Trống]</span>
                                    </div>
                                    <div class="seat w-1/2 h-14 bg-white rounded-md flex items-center justify-center text-center text-gray-500 p-1 border relative" data-seat-id="${rightSeatId}">
                                        <span class="seat-number absolute top-0.5 left-1 text-slate-400 text-[10px] font-semibold">${rightSeatNumber}</span>
                                        <span class="student-name text-xs leading-tight font-medium">[Trống]</span>
                                    </div>
                                </div>`;
                            desksInGroupWrapper.appendChild(deskContainer);
                        });
                        groupWrapper.appendChild(desksInGroupWrapper);
                        columnEl.appendChild(groupWrapper);
                    });
                    classroomDiv.appendChild(columnEl);
                }
                
                for (const groupName in groupToSeatsMap) {
                    groupToSeatsMap[groupName].sort((a, b) => a - b);
                }
                
                addDropListenersToSeats();
                updateSeatNumberDisplay();
            }

            function updateSeatNumberDisplay() {
                const mode = numberingModeSelect.value;
                document.querySelectorAll('.seat').forEach(seat => {
                    const seatId = seat.dataset.seatId;
                    const numberSpan = seat.querySelector('.seat-number');
                    if (numberSpan) {
                        numberSpan.textContent = mode === 'absolute' ? seatIdToAbsoluteNumber[seatId] : seatIdToGroupNumber[seatId];
                    }
                });
            }

            function getShortName(fullName) {
                const nameParts = fullName.trim().split(' ');
                if (nameParts.length <= 1) return fullName; 
                return nameParts.slice(1).join(' '); 
            }

            function getGivenName(fullName) {
                const nameParts = fullName.trim().split(' ');
                return nameParts[nameParts.length - 1];
            }
            
            fileUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                    processStudentData(jsonData);
                };
                reader.readAsArrayBuffer(file);
            });
            
            function processStudentData(data) {
                try {
                    const headerRow = data[6];
                    const firstStudentRow = data[7];
                    detectedSubjects = [];
                    let genderIndex = -1;
                    const ignoredHeaders = ['kq rèn luyện', 'danh hiệu', 'số ngày/ buổi nghỉ', 'trạng thái lên lớp'];

                    headerRow.forEach((header, index) => {
                         const headerText = String(header).trim().toLowerCase();
                         if (index >= 5 && header && !ignoredHeaders.includes(headerText)) { 
                            const cellValue = firstStudentRow[index] ? String(firstStudentRow[index]).trim().toLowerCase() : '';
                            const numericScore = parseFloat(cellValue.replace(',', '.'));
                            if (!isNaN(numericScore) || cellValue === 'đ') {
                                detectedSubjects.push({ name: String(header), index: index });
                            }
                         }
                         if (headerText.includes('giới')) {
                             genderIndex = index;
                         }
                    });

                    if(detectedSubjects.length === 0) {
                        alert('Không thể nhận diện các môn học. Vui lòng kiểm tra lại định dạng tệp.');
                        return;
                    }

                    createSubjectCheckboxes();

                    students = data.slice(7).map(row => {
                        if (!row || !row[1] || isNaN(parseFloat(row[0]))) return null;
                        
                        const fullName = String(row[1]).trim();
                        if (!fullName) return null;

                        const studentData = {
                            name: getShortName(fullName),
                            givenName: getGivenName(fullName),
                            fullName: fullName,
                            gender: genderIndex !== -1 ? String(row[genderIndex]).trim().toLowerCase() : 'n/a',
                            scores: {}
                        };

                        let hasData = false;
                        detectedSubjects.forEach(subject => {
                            const scoreStr = row[subject.index] ? String(row[subject.index]).trim().toLowerCase() : '';
                            const numericScore = parseFloat(scoreStr.replace(',', '.'));
                            
                            if (!isNaN(numericScore)) {
                                studentData.scores[subject.name] = numericScore;
                                hasData = true;
                            } else if (scoreStr === 'đ') {
                                studentData.scores[subject.name] = 1; 
                                hasData = true;
                            } else {
                                studentData.scores[subject.name] = 0;
                            }
                        });
                        
                        return hasData ? studentData : null;

                    }).filter(student => student !== null);

                    if (students.length === 0) {
                        alert('Không tìm thấy dữ liệu học sinh hợp lệ.');
                        return;
                    }
                    
                    updateStudentList(students);
                    arrangeBtn.disabled = false;
                    clearBtn.disabled = false;
                } catch (error) {
                    alert('Đã xảy ra lỗi khi xử lý tệp.');
                    console.error(error);
                }
            }

            function createSubjectCheckboxes() {
                subjectCheckboxesDiv.innerHTML = '';
                detectedSubjects.forEach(subject => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    const id = `cb-${subject.name.replace(/\s/g, '')}`;
                    const isChecked = ['Toán', 'Tin học'].includes(subject.name);
                    div.innerHTML = `
                        <input id="${id}" name="subject" value="${subject.name}" type="checkbox" ${isChecked ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="${id}" class="ml-2 block text-sm text-gray-900">${subject.name}</label>
                    `;
                    subjectCheckboxesDiv.appendChild(div);
                });
            }
            
            function updateStudentList(studentArray) {
                studentListDiv.innerHTML = '';
                studentArray.forEach(student => {
                    const studentItem = document.createElement('div');
                    studentItem.className = 'text-sm p-1.5 bg-white rounded-md mb-1.5 shadow-sm';
                    
                    let scoresHtml = Object.entries(student.scores)
                        .map(([name, score]) => `<span class="font-mono text-xs text-gray-600">${name.substring(0,3)}: ${score ?? 'N/A'}</span>`)
                        .join(' | ');

                    studentItem.innerHTML = `
                        <div class="flex justify-between items-center font-medium">${student.fullName}</div>
                        <div class="mt-1">${scoresHtml}</div>
                    `;
                    studentListDiv.appendChild(studentItem);
                });
                studentCountSpan.textContent = studentArray.length;
                studentListContainer.classList.remove('hidden');
            }

            criteriaSelect.addEventListener('change', () => {
                subjectCriteriaContainer.style.display = criteriaSelect.value === 'smart' ? 'block' : 'none';
            });

            numberingModeSelect.addEventListener('change', updateSeatNumberDisplay);
            
            arrangeBtn.addEventListener('click', () => {
                if (students.length === 0) return alert('Vui lòng tải lên danh sách lớp trước.');
                
                const criteria = criteriaSelect.value;
                let arrangedStudents = [...students];

                if (criteria === 'random') {
                    // Sắp xếp ngẫu nhiên (thuật toán Fisher-Yates)
                    for (let i = arrangedStudents.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [arrangedStudents[i], arrangedStudents[j]] = [arrangedStudents[j], arrangedStudents[i]];
                    }
                    populateClassroomRandomly(arrangedStudents);
                } else { 
                    const selectedSubjects = Array.from(subjectCheckboxesDiv.querySelectorAll('input:checked')).map(cb => cb.value);
                    if (selectedSubjects.length === 0) return alert('Vui lòng chọn ít nhất một môn học để sắp xếp thông minh.');

                    arrangedStudents.forEach(student => {
                        let sum = 0;
                        let count = 0;
                        selectedSubjects.forEach(subjectName => {
                            if (student.scores[subjectName] !== null && !isNaN(student.scores[subjectName])) {
                                sum += parseFloat(student.scores[subjectName]);
                                count++;
                            }
                        });
                        student.keyScore = count > 0 ? sum / count : 0;
                    });
                    
                    // Sắp xếp học sinh theo điểm tăng dần (học sinh yếu hơn ngồi trước)
                    arrangedStudents.sort((a, b) => a.keyScore - b.keyScore);
                    
                    const arrangementMap = customOrderArrangement(arrangedStudents);
                    populateClassroomFromMap(arrangementMap);
                }
                
                exportPdfBtn.disabled = false;
            });

            function customOrderArrangement(sortedStudents) {
                const finalArrangementMap = {};
                
                // Tạo một bản đồ ngược từ số hiệu nhóm (ví dụ: "4.6") sang seatId
                const groupNumberToSeatIdMap = Object.fromEntries(
                    Object.entries(seatIdToGroupNumber).map(([seatId, groupNum]) => [groupNum, seatId])
                );

                // Thứ tự sắp xếp tùy chỉnh mới theo yêu cầu
                const customGroupNumberOrder = [
                    '4.6', '1.6', '5.6', '2.6', '6.8', '3.8', '3.1', '6.1', '5.1', '2.1', '1.1', '4.1', 
                    '4.5', '1.5', '5.5', '2.5', '6.7', '3.7', '3.2', '6.2', '2.2', '5.2', '4.2', '1.2', 
                    '4.4', '1.4', '5.4', '2.4', '6.6', '3.6', '3.3', '6.3', '5.3', '2.3', '1.3', '4.3'
                ];

                // Chuyển đổi thứ tự số hiệu nhóm sang thứ tự seat ID
                let customSeatOrder = customGroupNumberOrder
                    .map(groupNum => groupNumberToSeatIdMap[groupNum])
                    .filter(id => id !== undefined);
                
                // Lấy tất cả các seat ID
                const allSeatIds = Object.keys(seatIdToAbsoluteNumber);
                
                // Tìm các ghế còn lại và thêm chúng vào cuối danh sách
                const arrangedSeatIds = new Set(customSeatOrder);
                const remainingSeatIds = allSeatIds.filter(id => !arrangedSeatIds.has(id));
                
                // Kết hợp thứ tự tùy chỉnh với các ghế còn lại
                const finalSeatOrder = [...customSeatOrder, ...remainingSeatIds];

                sortedStudents.forEach((student, index) => {
                    if (index < finalSeatOrder.length) {
                        const seatId = finalSeatOrder[index];
                        finalArrangementMap[seatId] = student;
                    }
                });

                return finalArrangementMap;
            }

            function populateClassroomFromMap(arrangementMap) {
                initializeClassroom(); 
                
                for(const seatId in arrangementMap) {
                    const student = arrangementMap[seatId];
                    const seat = document.querySelector(`.seat[data-seat-id='${seatId}']`);
                    if (seat) {
                        const studentNameSpan = seat.querySelector('.student-name');
                        studentNameSpan.textContent = student.name;
                        seat.title = `${student.fullName}\nĐiểm TB: ${student.keyScore.toFixed(2)}`;
                        seat.classList.remove('text-gray-500');
                        seat.classList.add('text-black', 'cursor-grab');
                        seat.draggable = true;
                        addDragListenersToStudent(seat);
                    }
                }
                updateStudentListByGroup(arrangementMap);
            }

            function populateClassroomRandomly(arrangedList) {
                initializeClassroom();
                
                const allSeats = document.querySelectorAll('.seat');
                arrangedList.forEach((student, index) => {
                    if (index < allSeats.length) {
                        const seat = allSeats[index];
                        if (seat) {
                            const studentNameSpan = seat.querySelector('.student-name');
                            studentNameSpan.textContent = student.name;
                            seat.title = `${student.fullName}`;
                            seat.classList.remove('text-gray-500');
                            seat.classList.add('text-black', 'cursor-grab');
                            seat.draggable = true;
                            addDragListenersToStudent(seat);
                        }
                    }
                });
                
                const arrangementMap = {};
                document.querySelectorAll('.seat').forEach(seat => {
                    const studentNameSpan = seat.querySelector('.student-name');
                    const studentName = studentNameSpan.textContent;
                    if(studentName !== '[Trống]') {
                         const studentObj = students.find(s => s.name === studentName);
                         if(studentObj) arrangementMap[seat.dataset.seatId] = studentObj;
                    }
                });
                updateStudentListByGroup(arrangementMap);
            }

             function updateStudentListByGroup(arrangementMap) {
                const studentsByGroup = Object.fromEntries(Object.keys(groupToSeatsMap).map(name => [name, []]));
                const groupOrder = ['N4', 'N1', 'N5', 'N2', 'N6', 'N3'];

                for(const seatId in arrangementMap) {
                    const student = arrangementMap[seatId];
                    const groupName = seatToGroupMap[seatId];
                    if (groupName && studentsByGroup[groupName]) {
                        studentsByGroup[groupName].push({student, seatId: parseInt(seatId)});
                    }
                }
                
                studentListDiv.innerHTML = '';
                let totalStudents = 0;

                groupOrder.forEach(groupName => {
                    const groupStudents = studentsByGroup[groupName];
                    if (groupStudents.length > 0) {
                        groupStudents.sort((a,b) => a.seatId - b.seatId);

                        const groupTitle = document.createElement('h4');
                        groupTitle.className = 'text-md font-semibold mt-3 mb-1 text-gray-800';
                        groupTitle.textContent = `Nhóm ${groupName}`;
                        studentListDiv.appendChild(groupTitle);

                        groupStudents.forEach(({student}) => {
                            totalStudents++;
                            const studentItem = document.createElement('div');
                            studentItem.className = 'text-sm p-1.5 bg-white rounded-md mb-1.5 shadow-sm flex justify-between items-center';
                            const keyScoreText = student.keyScore !== undefined ? student.keyScore.toFixed(2) : 'N/A';
                            studentItem.innerHTML = `
                                <span>${student.givenName}</span>
                                <span class="font-mono text-xs text-gray-600">ĐTB: ${keyScoreText}</span>
                            `;
                            studentListDiv.appendChild(studentItem);
                        });
                    }
                });
                 studentCountSpan.textContent = totalStudents;
                 studentListContainer.classList.remove('hidden');
            }
            
            function addDragListenersToStudent(element) {
                element.addEventListener('dragstart', (e) => {
                    draggedElement = e.target;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                });
                element.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                });
            }

            function addDropListenersToSeats() {
                 document.querySelectorAll('.seat').forEach(seat => {
                    seat.addEventListener('dragover', (e) => e.preventDefault());
                    seat.addEventListener('dragleave', (e) => seat.classList.remove('over'));
                    seat.addEventListener('dragenter', (e) => {
                        e.preventDefault();
                        seat.classList.add('over');
                    });
                    seat.addEventListener('drop', (e) => {
                        e.preventDefault();
                        seat.classList.remove('over');
                        if (draggedElement && draggedElement !== seat) {
                            const sourceNameSpan = draggedElement.querySelector('.student-name');
                            const targetNameSpan = seat.querySelector('.student-name');
                            
                            [sourceNameSpan.textContent, targetNameSpan.textContent] = [targetNameSpan.textContent, sourceNameSpan.textContent];
                            [draggedElement.title, seat.title] = [seat.title, draggedElement.title];

                            [draggedElement, seat].forEach(el => {
                                const nameSpan = el.querySelector('.student-name');
                                const isNowEmpty = nameSpan.textContent === '[Trống]';
                                el.draggable = !isNowEmpty;
                                el.classList.toggle('text-black', !isNowEmpty);
                                el.classList.toggle('cursor-grab', !isNowEmpty);
                                el.classList.toggle('text-gray-500', isNowEmpty);
                                if(isNowEmpty) {
                                    el.title = '';
                                }
                            });
                        }
                    });
                });
            }

            clearBtn.addEventListener('click', () => {
                initializeClassroom();
                exportPdfBtn.disabled = true;
                studentListDiv.innerHTML = '';
                studentListContainer.classList.add('hidden');
                studentCountSpan.textContent = '0';
            });
            
            exportPdfBtn.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const classroomElement = document.querySelector('main');
                
                html2canvas(classroomElement, {
                    scale: 2,
                    windowWidth: classroomElement.scrollWidth,
                    windowHeight: classroomElement.scrollHeight
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    
                    const pdf = new jsPDF({
                        orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                        unit: 'px',
                        format: [canvas.width, canvas.height]
                    });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`so-do-lop-hoc-${new Date().toISOString().slice(0,10)}.pdf`);
                });
            });

            initializeClassroom();
        });
    </script>
</body>
</html>

